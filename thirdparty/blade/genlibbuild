#!/bin/bash
# generate BUILD file for library dir
# @author CHEN Feng <phongchen@tencent.com>

shopt -s nullglob

libname=$(basename $(pwd))

echo -e "# generated by $(basename $0)\n"

# generate proto_library
for src in *.proto; do
    echo -e "proto_library(\n    name = '${src/./_}',\n    srcs = '$src'\n)\n"
done

# generate proto_library
for src in proto/*.proto; do
    echo -e "proto_library(\n    name = '${src/./_}',\n    srcs = '$src'\n)\n"
done

# generate cc_library
test_src_pattern='_test\.c.*$'
has_src=0
for src in *.{c,cc,cpp,cxx}; do
    if ! [[ $src =~ $test_src_pattern ]]; then
        has_src=1
    fi
done
if [[ ${has_src} -eq 1 ]]; then
    echo -e "cc_library(\n    name = '$libname',\n    srcs = ["
    for src in *.{c,cc,cpp,cxx}; do
        if ! [[ $src =~ $test_src_pattern ]]; then
            echo "        '$src',"
        fi
    done
    echo -e "    ]\n)\n"
fi

test_src_pattern='_test\.c.*$'
has_src=0
for src in src/*.{c,cc,cpp,cxx}; do
    if ! [[ $src =~ $test_src_pattern ]]; then
        has_src=1
    fi
done
if [[ ${has_src} -eq 1 ]]; then
    echo -e "cc_library(\n    name = '$libname',\n    srcs = ["
    for src in src/*.{c,cc,cpp,cxx}; do
        if ! [[ $src =~ $test_src_pattern ]]; then
            echo "        '$src',"
        fi
    done
    echo -e "    ]\n)\n"
fi

# generate cc_test
for src in *_test.{c,cc,cpp,cxx}; do
    echo -e "\ncc_test(\n    name = '${src/.*/}',\n    srcs = ['$src'],\n    deps = [':$libname']\n)\n"
done


